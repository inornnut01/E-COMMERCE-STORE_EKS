name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: 875136960360.dkr.ecr.us-east-1.amazonaws.com
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}

jobs:
  # ============================================
  # Job 1: Test
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Backend Tests
      - name: Install Backend Dependencies
        run: npm install

      - name: Run Backend Tests
        run: npm run test -- --coverage

      # Frontend Tests
      - name: Install Frontend Dependencies
        run: npm install --prefix frontend

      - name: Run Frontend Tests
        run: npm run test:run --prefix frontend -- --coverage

      # SonarQube Analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=inornnut01_E-COMMERCE-STORE_EKS
            -Dsonar.organization=inornnut01
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info,frontend/coverage/lcov.info
            -Dsonar.sources=backend,frontend/src
            -Dsonar.tests=backend/test,frontend/src/stores/__tests__
            -Dsonar.exclusions=**/node_modules/**,**/coverage/**
            -Dsonar.test.inclusions=**/*.test.js,**/*.test.jsx

  # ============================================
  # Job 2: Build & Push Docker Images to ECR
  # ============================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Backend Image
        run: |
          docker build -t ${{ env.ECR_REGISTRY }}/e-commerce-store/backend:${{ github.sha }} \
                       -t ${{ env.ECR_REGISTRY }}/e-commerce-store/backend:latest \
                       -f docker/backend/Dockerfile .
          docker push ${{ env.ECR_REGISTRY }}/e-commerce-store/backend:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/e-commerce-store/backend:latest

      - name: Build & Push Frontend Image
        run: |
          docker build -t ${{ env.ECR_REGISTRY }}/e-commerce-store/frontend:${{ github.sha }} \
                       -t ${{ env.ECR_REGISTRY }}/e-commerce-store/frontend:latest \
                       -f docker/frontend/Dockerfile .
          docker push ${{ env.ECR_REGISTRY }}/e-commerce-store/frontend:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/e-commerce-store/frontend:latest

      - name: Build & Push Order Processor Image
        run: |
          docker build -t ${{ env.ECR_REGISTRY }}/e-commerce-store/order-processor:${{ github.sha }} \
                       -t ${{ env.ECR_REGISTRY }}/e-commerce-store/order-processor:latest \
                       -f docker/order-processor/Dockerfile .
          docker push ${{ env.ECR_REGISTRY }}/e-commerce-store/order-processor:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/e-commerce-store/order-processor:latest

  # ============================================
  # Job 3: Deploy to EKS
  # ============================================
  # deploy:
  #   name: Deploy to EKS
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: ${{ env.AWS_REGION }}

  #     - name: Update kubeconfig
  #       run: |
  #         aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

  #     - name: Deploy Backend
  #       run: |
  #         kubectl set image deployment/backend \
  #           backend=${{ env.ECR_REGISTRY }}/e-commerce-store/backend:${{ github.sha }} \
  #           -n e-commerce-store
  #         kubectl rollout status deployment/backend -n e-commerce-store --timeout=300s

  #     - name: Deploy Frontend
  #       run: |
  #         kubectl set image deployment/frontend \
  #           frontend=${{ env.ECR_REGISTRY }}/e-commerce-store/frontend:${{ github.sha }} \
  #           -n e-commerce-store
  #         kubectl rollout status deployment/frontend -n e-commerce-store --timeout=300s

  #     - name: Deploy Order Processor
  #       run: |
  #         kubectl set image deployment/order-processor \
  #           order-processor=${{ env.ECR_REGISTRY }}/e-commerce-store/order-processor:${{ github.sha }} \
  #           -n e-commerce-store
  #         kubectl rollout status deployment/order-processor -n e-commerce-store --timeout=300s

  #     - name: Verify Deployment
  #       run: |
  #         echo "=== Deployment Status ==="
  #         kubectl get deployments -n e-commerce-store
  #         echo ""
  #         echo "=== Pod Status ==="
  #         kubectl get pods -n e-commerce-store
